"use strict";(self.webpackChunkocap=self.webpackChunkocap||[]).push([[4656],{"./node_modules/expr-eval/dist/index.mjs":(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{_b:()=>Parser});var INUMBER="INUMBER",IOP1="IOP1",IOP2="IOP2",IOP3="IOP3",IVAR="IVAR",IVARNAME="IVARNAME",IFUNCALL="IFUNCALL",IFUNDEF="IFUNDEF",IEXPR="IEXPR",IEXPREVAL="IEXPREVAL",IMEMBER="IMEMBER",IENDSTATEMENT="IENDSTATEMENT",IARRAY="IARRAY";function Instruction(type,value){this.type=type,this.value=null!=value?value:0}function unaryInstruction(value){return new Instruction(IOP1,value)}function binaryInstruction(value){return new Instruction(IOP2,value)}function ternaryInstruction(value){return new Instruction(IOP3,value)}function simplify(tokens,unaryOps,binaryOps,ternaryOps,values){for(var n1,n2,n3,f,nstack=[],newexpression=[],i=0;i<tokens.length;i++){var item=tokens[i],type=item.type;if(type===INUMBER||type===IVARNAME)Array.isArray(item.value)?nstack.push.apply(nstack,simplify(item.value.map((function(x){return new Instruction(INUMBER,x)})).concat(new Instruction(IARRAY,item.value.length)),unaryOps,binaryOps,ternaryOps,values)):nstack.push(item);else if(type===IVAR&&values.hasOwnProperty(item.value))item=new Instruction(INUMBER,values[item.value]),nstack.push(item);else if(type===IOP2&&nstack.length>1)n2=nstack.pop(),n1=nstack.pop(),f=binaryOps[item.value],item=new Instruction(INUMBER,f(n1.value,n2.value)),nstack.push(item);else if(type===IOP3&&nstack.length>2)n3=nstack.pop(),n2=nstack.pop(),n1=nstack.pop(),"?"===item.value?nstack.push(n1.value?n2.value:n3.value):(f=ternaryOps[item.value],item=new Instruction(INUMBER,f(n1.value,n2.value,n3.value)),nstack.push(item));else if(type===IOP1&&nstack.length>0)n1=nstack.pop(),f=unaryOps[item.value],item=new Instruction(INUMBER,f(n1.value)),nstack.push(item);else if(type===IEXPR){for(;nstack.length>0;)newexpression.push(nstack.shift());newexpression.push(new Instruction(IEXPR,simplify(item.value,unaryOps,binaryOps,ternaryOps,values)))}else if(type===IMEMBER&&nstack.length>0)n1=nstack.pop(),nstack.push(new Instruction(INUMBER,n1.value[item.value]));else{for(;nstack.length>0;)newexpression.push(nstack.shift());newexpression.push(item)}}for(;nstack.length>0;)newexpression.push(nstack.shift());return newexpression}function substitute(tokens,variable,expr){for(var newexpression=[],i=0;i<tokens.length;i++){var item=tokens[i],type=item.type;if(type===IVAR&&item.value===variable)for(var j=0;j<expr.tokens.length;j++){var replitem,expritem=expr.tokens[j];replitem=expritem.type===IOP1?unaryInstruction(expritem.value):expritem.type===IOP2?binaryInstruction(expritem.value):expritem.type===IOP3?ternaryInstruction(expritem.value):new Instruction(expritem.type,expritem.value),newexpression.push(replitem)}else type===IEXPR?newexpression.push(new Instruction(IEXPR,substitute(item.value,variable,expr))):newexpression.push(item)}return newexpression}function evaluate(tokens,expr,values){var n1,n2,n3,f,args,argCount,nstack=[];if(isExpressionEvaluator(tokens))return resolveExpression(tokens,values);for(var numTokens=tokens.length,i=0;i<numTokens;i++){var item=tokens[i],type=item.type;if(type===INUMBER||type===IVARNAME)nstack.push(item.value);else if(type===IOP2)n2=nstack.pop(),n1=nstack.pop(),"and"===item.value?nstack.push(!!n1&&!!evaluate(n2,expr,values)):"or"===item.value?nstack.push(!!n1||!!evaluate(n2,expr,values)):"="===item.value?(f=expr.binaryOps[item.value],nstack.push(f(n1,evaluate(n2,expr,values),values))):(f=expr.binaryOps[item.value],nstack.push(f(resolveExpression(n1,values),resolveExpression(n2,values))));else if(type===IOP3)n3=nstack.pop(),n2=nstack.pop(),n1=nstack.pop(),"?"===item.value?nstack.push(evaluate(n1?n2:n3,expr,values)):(f=expr.ternaryOps[item.value],nstack.push(f(resolveExpression(n1,values),resolveExpression(n2,values),resolveExpression(n3,values))));else if(type===IVAR)if(item.value in expr.functions)nstack.push(expr.functions[item.value]);else if(item.value in expr.unaryOps&&expr.parser.isOperatorEnabled(item.value))nstack.push(expr.unaryOps[item.value]);else{var v=values[item.value];if(void 0===v)throw new Error("undefined variable: "+item.value);nstack.push(v)}else if(type===IOP1)n1=nstack.pop(),f=expr.unaryOps[item.value],nstack.push(f(resolveExpression(n1,values)));else if(type===IFUNCALL){for(argCount=item.value,args=[];argCount-- >0;)args.unshift(resolveExpression(nstack.pop(),values));if(!(f=nstack.pop()).apply||!f.call)throw new Error(f+" is not a function");nstack.push(f.apply(void 0,args))}else if(type===IFUNDEF)nstack.push(function(){for(var n2=nstack.pop(),args=[],argCount=item.value;argCount-- >0;)args.unshift(nstack.pop());var n1=nstack.pop(),f=function(){for(var scope=Object.assign({},values),i=0,len=args.length;i<len;i++)scope[args[i]]=arguments[i];return evaluate(n2,expr,scope)};return Object.defineProperty(f,"name",{value:n1,writable:!1}),values[n1]=f,f}());else if(type===IEXPR)nstack.push(createExpressionEvaluator(item,expr));else if(type===IEXPREVAL)nstack.push(item);else if(type===IMEMBER)n1=nstack.pop(),nstack.push(n1[item.value]);else if(type===IENDSTATEMENT)nstack.pop();else{if(type!==IARRAY)throw new Error("invalid Expression");for(argCount=item.value,args=[];argCount-- >0;)args.unshift(nstack.pop());nstack.push(args)}}if(nstack.length>1)throw new Error("invalid Expression (parity)");return 0===nstack[0]?0:resolveExpression(nstack[0],values)}function createExpressionEvaluator(token,expr,values){return isExpressionEvaluator(token)?token:{type:IEXPREVAL,value:function(scope){return evaluate(token.value,expr,scope)}}}function isExpressionEvaluator(n){return n&&n.type===IEXPREVAL}function resolveExpression(n,values){return isExpressionEvaluator(n)?n.value(values):n}function expressionToString(tokens,toJS){for(var n1,n2,n3,f,args,argCount,nstack=[],i=0;i<tokens.length;i++){var item=tokens[i],type=item.type;if(type===INUMBER)"number"==typeof item.value&&item.value<0?nstack.push("("+item.value+")"):Array.isArray(item.value)?nstack.push("["+item.value.map(escapeValue).join(", ")+"]"):nstack.push(escapeValue(item.value));else if(type===IOP2)n2=nstack.pop(),n1=nstack.pop(),f=item.value,toJS?"^"===f?nstack.push("Math.pow("+n1+", "+n2+")"):"and"===f?nstack.push("(!!"+n1+" && !!"+n2+")"):"or"===f?nstack.push("(!!"+n1+" || !!"+n2+")"):"||"===f?nstack.push("(function(a,b){ return Array.isArray(a) && Array.isArray(b) ? a.concat(b) : String(a) + String(b); }(("+n1+"),("+n2+")))"):"=="===f?nstack.push("("+n1+" === "+n2+")"):"!="===f?nstack.push("("+n1+" !== "+n2+")"):"["===f?nstack.push(n1+"[("+n2+") | 0]"):nstack.push("("+n1+" "+f+" "+n2+")"):"["===f?nstack.push(n1+"["+n2+"]"):nstack.push("("+n1+" "+f+" "+n2+")");else if(type===IOP3){if(n3=nstack.pop(),n2=nstack.pop(),n1=nstack.pop(),"?"!==(f=item.value))throw new Error("invalid Expression");nstack.push("("+n1+" ? "+n2+" : "+n3+")")}else if(type===IVAR||type===IVARNAME)nstack.push(item.value);else if(type===IOP1)n1=nstack.pop(),"-"===(f=item.value)||"+"===f?nstack.push("("+f+n1+")"):toJS?"not"===f?nstack.push("(!"+n1+")"):"!"===f?nstack.push("fac("+n1+")"):nstack.push(f+"("+n1+")"):"!"===f?nstack.push("("+n1+"!)"):nstack.push("("+f+" "+n1+")");else if(type===IFUNCALL){for(argCount=item.value,args=[];argCount-- >0;)args.unshift(nstack.pop());f=nstack.pop(),nstack.push(f+"("+args.join(", ")+")")}else if(type===IFUNDEF){for(n2=nstack.pop(),argCount=item.value,args=[];argCount-- >0;)args.unshift(nstack.pop());n1=nstack.pop(),toJS?nstack.push("("+n1+" = function("+args.join(", ")+") { return "+n2+" })"):nstack.push("("+n1+"("+args.join(", ")+") = "+n2+")")}else if(type===IMEMBER)n1=nstack.pop(),nstack.push(n1+"."+item.value);else if(type===IARRAY){for(argCount=item.value,args=[];argCount-- >0;)args.unshift(nstack.pop());nstack.push("["+args.join(", ")+"]")}else if(type===IEXPR)nstack.push("("+expressionToString(item.value,toJS)+")");else if(type!==IENDSTATEMENT)throw new Error("invalid Expression")}return nstack.length>1&&(nstack=toJS?[nstack.join(",")]:[nstack.join(";")]),String(nstack[0])}function escapeValue(v){return"string"==typeof v?JSON.stringify(v).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"):v}function contains(array,obj){for(var i=0;i<array.length;i++)if(array[i]===obj)return!0;return!1}function getSymbols(tokens,symbols,options){for(var withMembers=!!(options=options||{}).withMembers,prevVar=null,i=0;i<tokens.length;i++){var item=tokens[i];item.type===IVAR||item.type===IVARNAME?withMembers||contains(symbols,item.value)?null!==prevVar?(contains(symbols,prevVar)||symbols.push(prevVar),prevVar=item.value):prevVar=item.value:symbols.push(item.value):item.type===IMEMBER&&withMembers&&null!==prevVar?prevVar+="."+item.value:item.type===IEXPR?getSymbols(item.value,symbols,options):null!==prevVar&&(contains(symbols,prevVar)||symbols.push(prevVar),prevVar=null)}null===prevVar||contains(symbols,prevVar)||symbols.push(prevVar)}function Expression(tokens,parser){this.tokens=tokens,this.parser=parser,this.unaryOps=parser.unaryOps,this.binaryOps=parser.binaryOps,this.ternaryOps=parser.ternaryOps,this.functions=parser.functions}Instruction.prototype.toString=function(){switch(this.type){case INUMBER:case IOP1:case IOP2:case IOP3:case IVAR:case IVARNAME:case IENDSTATEMENT:return this.value;case IFUNCALL:return"CALL "+this.value;case IFUNDEF:return"DEF "+this.value;case IARRAY:return"ARRAY "+this.value;case IMEMBER:return"."+this.value;default:return"Invalid Instruction"}},Expression.prototype.simplify=function(values){return values=values||{},new Expression(simplify(this.tokens,this.unaryOps,this.binaryOps,this.ternaryOps,values),this.parser)},Expression.prototype.substitute=function(variable,expr){return expr instanceof Expression||(expr=this.parser.parse(String(expr))),new Expression(substitute(this.tokens,variable,expr),this.parser)},Expression.prototype.evaluate=function(values){return values=values||{},evaluate(this.tokens,this,values)},Expression.prototype.toString=function(){return expressionToString(this.tokens,!1)},Expression.prototype.symbols=function(options){options=options||{};var vars=[];return getSymbols(this.tokens,vars,options),vars},Expression.prototype.variables=function(options){options=options||{};var vars=[];getSymbols(this.tokens,vars,options);var functions=this.functions;return vars.filter((function(name){return!(name in functions)}))},Expression.prototype.toJSFunction=function(param,variables){var expr=this,f=new Function(param,"with(this.functions) with (this.ternaryOps) with (this.binaryOps) with (this.unaryOps) { return "+expressionToString(this.simplify(variables).tokens,!0)+"; }");return function(){return f.apply(expr,arguments)}};var TOP="TOP",TPAREN="TPAREN";function Token(type,value,index){this.type=type,this.value=value,this.index=index}function TokenStream(parser,expression){this.pos=0,this.current=null,this.unaryOps=parser.unaryOps,this.binaryOps=parser.binaryOps,this.ternaryOps=parser.ternaryOps,this.consts=parser.consts,this.expression=expression,this.savedPosition=0,this.savedCurrent=null,this.options=parser.options,this.parser=parser}Token.prototype.toString=function(){return this.type+": "+this.value},TokenStream.prototype.newToken=function(type,value,pos){return new Token(type,value,null!=pos?pos:this.pos)},TokenStream.prototype.save=function(){this.savedPosition=this.pos,this.savedCurrent=this.current},TokenStream.prototype.restore=function(){this.pos=this.savedPosition,this.current=this.savedCurrent},TokenStream.prototype.next=function(){return this.pos>=this.expression.length?this.newToken("TEOF","EOF"):this.isWhitespace()||this.isComment()?this.next():this.isRadixInteger()||this.isNumber()||this.isOperator()||this.isString()||this.isParen()||this.isBracket()||this.isComma()||this.isSemicolon()||this.isNamedOp()||this.isConst()||this.isName()?this.current:void this.parseError('Unknown character "'+this.expression.charAt(this.pos)+'"')},TokenStream.prototype.isString=function(){var r=!1,startPos=this.pos,quote=this.expression.charAt(startPos);if("'"===quote||'"'===quote)for(var index=this.expression.indexOf(quote,startPos+1);index>=0&&this.pos<this.expression.length;){if(this.pos=index+1,"\\"!==this.expression.charAt(index-1)){var rawString=this.expression.substring(startPos+1,index);this.current=this.newToken("TSTRING",this.unescape(rawString),startPos),r=!0;break}index=this.expression.indexOf(quote,index+1)}return r},TokenStream.prototype.isParen=function(){var c=this.expression.charAt(this.pos);return("("===c||")"===c)&&(this.current=this.newToken(TPAREN,c),this.pos++,!0)},TokenStream.prototype.isBracket=function(){var c=this.expression.charAt(this.pos);return!("["!==c&&"]"!==c||!this.isOperatorEnabled("["))&&(this.current=this.newToken("TBRACKET",c),this.pos++,!0)},TokenStream.prototype.isComma=function(){return","===this.expression.charAt(this.pos)&&(this.current=this.newToken("TCOMMA",","),this.pos++,!0)},TokenStream.prototype.isSemicolon=function(){return";"===this.expression.charAt(this.pos)&&(this.current=this.newToken("TSEMICOLON",";"),this.pos++,!0)},TokenStream.prototype.isConst=function(){for(var startPos=this.pos,i=startPos;i<this.expression.length;i++){var c=this.expression.charAt(i);if(c.toUpperCase()===c.toLowerCase()&&(i===this.pos||"_"!==c&&"."!==c&&(c<"0"||c>"9")))break}if(i>startPos){var str=this.expression.substring(startPos,i);if(str in this.consts)return this.current=this.newToken("TNUMBER",this.consts[str]),this.pos+=str.length,!0}return!1},TokenStream.prototype.isNamedOp=function(){for(var startPos=this.pos,i=startPos;i<this.expression.length;i++){var c=this.expression.charAt(i);if(c.toUpperCase()===c.toLowerCase()&&(i===this.pos||"_"!==c&&(c<"0"||c>"9")))break}if(i>startPos){var str=this.expression.substring(startPos,i);if(this.isOperatorEnabled(str)&&(str in this.binaryOps||str in this.unaryOps||str in this.ternaryOps))return this.current=this.newToken(TOP,str),this.pos+=str.length,!0}return!1},TokenStream.prototype.isName=function(){for(var startPos=this.pos,i=startPos,hasLetter=!1;i<this.expression.length;i++){var c=this.expression.charAt(i);if(c.toUpperCase()===c.toLowerCase()){if(i===this.pos&&("$"===c||"_"===c)){"_"===c&&(hasLetter=!0);continue}if(i===this.pos||!hasLetter||"_"!==c&&(c<"0"||c>"9"))break}else hasLetter=!0}if(hasLetter){var str=this.expression.substring(startPos,i);return this.current=this.newToken("TNAME",str),this.pos+=str.length,!0}return!1},TokenStream.prototype.isWhitespace=function(){for(var r=!1,c=this.expression.charAt(this.pos);!(" "!==c&&"\t"!==c&&"\n"!==c&&"\r"!==c||(r=!0,this.pos++,this.pos>=this.expression.length));)c=this.expression.charAt(this.pos);return r};var codePointPattern=/^[0-9a-f]{4}$/i;function ParserState(parser,tokenStream,options){this.parser=parser,this.tokens=tokenStream,this.current=null,this.nextToken=null,this.next(),this.savedCurrent=null,this.savedNextToken=null,this.allowMemberAccess=!1!==options.allowMemberAccess}TokenStream.prototype.unescape=function(v){var index=v.indexOf("\\");if(index<0)return v;for(var buffer=v.substring(0,index);index>=0;){var c=v.charAt(++index);switch(c){case"'":buffer+="'";break;case'"':buffer+='"';break;case"\\":buffer+="\\";break;case"/":buffer+="/";break;case"b":buffer+="\b";break;case"f":buffer+="\f";break;case"n":buffer+="\n";break;case"r":buffer+="\r";break;case"t":buffer+="\t";break;case"u":var codePoint=v.substring(index+1,index+5);codePointPattern.test(codePoint)||this.parseError("Illegal escape sequence: \\u"+codePoint),buffer+=String.fromCharCode(parseInt(codePoint,16)),index+=4;break;default:throw this.parseError('Illegal escape sequence: "\\'+c+'"')}++index;var backslash=v.indexOf("\\",index);buffer+=v.substring(index,backslash<0?v.length:backslash),index=backslash}return buffer},TokenStream.prototype.isComment=function(){return"/"===this.expression.charAt(this.pos)&&"*"===this.expression.charAt(this.pos+1)&&(this.pos=this.expression.indexOf("*/",this.pos)+2,1===this.pos&&(this.pos=this.expression.length),!0)},TokenStream.prototype.isRadixInteger=function(){var radix,validDigit,pos=this.pos;if(pos>=this.expression.length-2||"0"!==this.expression.charAt(pos))return!1;if(++pos,"x"===this.expression.charAt(pos))radix=16,validDigit=/^[0-9a-f]$/i,++pos;else{if("b"!==this.expression.charAt(pos))return!1;radix=2,validDigit=/^[01]$/i,++pos}for(var valid=!1,startPos=pos;pos<this.expression.length;){var c=this.expression.charAt(pos);if(!validDigit.test(c))break;pos++,valid=!0}return valid&&(this.current=this.newToken("TNUMBER",parseInt(this.expression.substring(startPos,pos),radix)),this.pos=pos),valid},TokenStream.prototype.isNumber=function(){for(var c,valid=!1,pos=this.pos,startPos=pos,resetPos=pos,foundDot=!1,foundDigits=!1;pos<this.expression.length&&((c=this.expression.charAt(pos))>="0"&&c<="9"||!foundDot&&"."===c);)"."===c?foundDot=!0:foundDigits=!0,pos++,valid=foundDigits;if(valid&&(resetPos=pos),"e"===c||"E"===c){pos++;for(var acceptSign=!0,validExponent=!1;pos<this.expression.length;){if(c=this.expression.charAt(pos),!acceptSign||"+"!==c&&"-"!==c){if(!(c>="0"&&c<="9"))break;validExponent=!0,acceptSign=!1}else acceptSign=!1;pos++}validExponent||(pos=resetPos)}return valid?(this.current=this.newToken("TNUMBER",parseFloat(this.expression.substring(startPos,pos))),this.pos=pos):this.pos=resetPos,valid},TokenStream.prototype.isOperator=function(){var startPos=this.pos,c=this.expression.charAt(this.pos);if("+"===c||"-"===c||"*"===c||"/"===c||"%"===c||"^"===c||"?"===c||":"===c||"."===c)this.current=this.newToken(TOP,c);else if("∙"===c||"•"===c)this.current=this.newToken(TOP,"*");else if(">"===c)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,">="),this.pos++):this.current=this.newToken(TOP,">");else if("<"===c)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,"<="),this.pos++):this.current=this.newToken(TOP,"<");else if("|"===c){if("|"!==this.expression.charAt(this.pos+1))return!1;this.current=this.newToken(TOP,"||"),this.pos++}else if("="===c)"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,"=="),this.pos++):this.current=this.newToken(TOP,c);else{if("!"!==c)return!1;"="===this.expression.charAt(this.pos+1)?(this.current=this.newToken(TOP,"!="),this.pos++):this.current=this.newToken(TOP,c)}return this.pos++,!!this.isOperatorEnabled(this.current.value)||(this.pos=startPos,!1)},TokenStream.prototype.isOperatorEnabled=function(op){return this.parser.isOperatorEnabled(op)},TokenStream.prototype.getCoordinates=function(){var column,line=0,newline=-1;do{line++,column=this.pos-newline,newline=this.expression.indexOf("\n",newline+1)}while(newline>=0&&newline<this.pos);return{line,column}},TokenStream.prototype.parseError=function(msg){var coords=this.getCoordinates();throw new Error("parse error ["+coords.line+":"+coords.column+"]: "+msg)},ParserState.prototype.next=function(){return this.current=this.nextToken,this.nextToken=this.tokens.next()},ParserState.prototype.tokenMatches=function(token,value){return void 0===value||(Array.isArray(value)?contains(value,token.value):"function"==typeof value?value(token):token.value===value)},ParserState.prototype.save=function(){this.savedCurrent=this.current,this.savedNextToken=this.nextToken,this.tokens.save()},ParserState.prototype.restore=function(){this.tokens.restore(),this.current=this.savedCurrent,this.nextToken=this.savedNextToken},ParserState.prototype.accept=function(type,value){return!(this.nextToken.type!==type||!this.tokenMatches(this.nextToken,value))&&(this.next(),!0)},ParserState.prototype.expect=function(type,value){if(!this.accept(type,value)){var coords=this.tokens.getCoordinates();throw new Error("parse error ["+coords.line+":"+coords.column+"]: Expected "+(value||type))}},ParserState.prototype.parseAtom=function(instr){var unaryOps=this.tokens.unaryOps;if(this.accept("TNAME")||this.accept(TOP,(function isPrefixOperator(token){return token.value in unaryOps})))instr.push(new Instruction(IVAR,this.current.value));else if(this.accept("TNUMBER"))instr.push(new Instruction(INUMBER,this.current.value));else if(this.accept("TSTRING"))instr.push(new Instruction(INUMBER,this.current.value));else if(this.accept(TPAREN,"("))this.parseExpression(instr),this.expect(TPAREN,")");else{if(!this.accept("TBRACKET","["))throw new Error("unexpected "+this.nextToken);if(this.accept("TBRACKET","]"))instr.push(new Instruction(IARRAY,0));else{var argCount=this.parseArrayList(instr);instr.push(new Instruction(IARRAY,argCount))}}},ParserState.prototype.parseExpression=function(instr){var exprInstr=[];this.parseUntilEndStatement(instr,exprInstr)||(this.parseVariableAssignmentExpression(exprInstr),this.parseUntilEndStatement(instr,exprInstr)||this.pushExpression(instr,exprInstr))},ParserState.prototype.pushExpression=function(instr,exprInstr){for(var i=0,len=exprInstr.length;i<len;i++)instr.push(exprInstr[i])},ParserState.prototype.parseUntilEndStatement=function(instr,exprInstr){return!!this.accept("TSEMICOLON")&&(!this.nextToken||"TEOF"===this.nextToken.type||this.nextToken.type===TPAREN&&")"===this.nextToken.value||exprInstr.push(new Instruction(IENDSTATEMENT)),"TEOF"!==this.nextToken.type&&this.parseExpression(exprInstr),instr.push(new Instruction(IEXPR,exprInstr)),!0)},ParserState.prototype.parseArrayList=function(instr){for(var argCount=0;!this.accept("TBRACKET","]");)for(this.parseExpression(instr),++argCount;this.accept("TCOMMA");)this.parseExpression(instr),++argCount;return argCount},ParserState.prototype.parseVariableAssignmentExpression=function(instr){for(this.parseConditionalExpression(instr);this.accept(TOP,"=");){var varName=instr.pop(),varValue=[],lastInstrIndex=instr.length-1;if(varName.type!==IFUNCALL){if(varName.type!==IVAR&&varName.type!==IMEMBER)throw new Error("expected variable for assignment");this.parseVariableAssignmentExpression(varValue),instr.push(new Instruction(IVARNAME,varName.value)),instr.push(new Instruction(IEXPR,varValue)),instr.push(binaryInstruction("="))}else{if(!this.tokens.isOperatorEnabled("()="))throw new Error("function definition is not permitted");for(var i=0,len=varName.value+1;i<len;i++){var index=lastInstrIndex-i;instr[index].type===IVAR&&(instr[index]=new Instruction(IVARNAME,instr[index].value))}this.parseVariableAssignmentExpression(varValue),instr.push(new Instruction(IEXPR,varValue)),instr.push(new Instruction(IFUNDEF,varName.value))}}},ParserState.prototype.parseConditionalExpression=function(instr){for(this.parseOrExpression(instr);this.accept(TOP,"?");){var trueBranch=[],falseBranch=[];this.parseConditionalExpression(trueBranch),this.expect(TOP,":"),this.parseConditionalExpression(falseBranch),instr.push(new Instruction(IEXPR,trueBranch)),instr.push(new Instruction(IEXPR,falseBranch)),instr.push(ternaryInstruction("?"))}},ParserState.prototype.parseOrExpression=function(instr){for(this.parseAndExpression(instr);this.accept(TOP,"or");){var falseBranch=[];this.parseAndExpression(falseBranch),instr.push(new Instruction(IEXPR,falseBranch)),instr.push(binaryInstruction("or"))}},ParserState.prototype.parseAndExpression=function(instr){for(this.parseComparison(instr);this.accept(TOP,"and");){var trueBranch=[];this.parseComparison(trueBranch),instr.push(new Instruction(IEXPR,trueBranch)),instr.push(binaryInstruction("and"))}};var COMPARISON_OPERATORS=["==","!=","<","<=",">=",">","in"];ParserState.prototype.parseComparison=function(instr){for(this.parseAddSub(instr);this.accept(TOP,COMPARISON_OPERATORS);){var op=this.current;this.parseAddSub(instr),instr.push(binaryInstruction(op.value))}};var ADD_SUB_OPERATORS=["+","-","||"];ParserState.prototype.parseAddSub=function(instr){for(this.parseTerm(instr);this.accept(TOP,ADD_SUB_OPERATORS);){var op=this.current;this.parseTerm(instr),instr.push(binaryInstruction(op.value))}};var TERM_OPERATORS=["*","/","%"];function add(a,b){return Number(a)+Number(b)}function sub(a,b){return a-b}function mul(a,b){return a*b}function div(a,b){return a/b}function mod(a,b){return a%b}function concat(a,b){return Array.isArray(a)&&Array.isArray(b)?a.concat(b):""+a+b}function equal(a,b){return a===b}function notEqual(a,b){return a!==b}function greaterThan(a,b){return a>b}function lessThan(a,b){return a<b}function greaterThanEqual(a,b){return a>=b}function lessThanEqual(a,b){return a<=b}function andOperator(a,b){return Boolean(a&&b)}function orOperator(a,b){return Boolean(a||b)}function inOperator(a,b){return contains(b,a)}function sinh(a){return(Math.exp(a)-Math.exp(-a))/2}function cosh(a){return(Math.exp(a)+Math.exp(-a))/2}function tanh(a){return a===1/0?1:a===-1/0?-1:(Math.exp(a)-Math.exp(-a))/(Math.exp(a)+Math.exp(-a))}function asinh(a){return a===-1/0?a:Math.log(a+Math.sqrt(a*a+1))}function acosh(a){return Math.log(a+Math.sqrt(a*a-1))}function atanh(a){return Math.log((1+a)/(1-a))/2}function log10(a){return Math.log(a)*Math.LOG10E}function neg(a){return-a}function not(a){return!a}function trunc(a){return a<0?Math.ceil(a):Math.floor(a)}function random(a){return Math.random()*(a||1)}function factorial(a){return gamma(a+1)}ParserState.prototype.parseTerm=function(instr){for(this.parseFactor(instr);this.accept(TOP,TERM_OPERATORS);){var op=this.current;this.parseFactor(instr),instr.push(binaryInstruction(op.value))}},ParserState.prototype.parseFactor=function(instr){var unaryOps=this.tokens.unaryOps;if(this.save(),this.accept(TOP,(function isPrefixOperator(token){return token.value in unaryOps}))){if("-"!==this.current.value&&"+"!==this.current.value){if(this.nextToken.type===TPAREN&&"("===this.nextToken.value)return this.restore(),void this.parseExponential(instr);if("TSEMICOLON"===this.nextToken.type||"TCOMMA"===this.nextToken.type||"TEOF"===this.nextToken.type||this.nextToken.type===TPAREN&&")"===this.nextToken.value)return this.restore(),void this.parseAtom(instr)}var op=this.current;this.parseFactor(instr),instr.push(unaryInstruction(op.value))}else this.parseExponential(instr)},ParserState.prototype.parseExponential=function(instr){for(this.parsePostfixExpression(instr);this.accept(TOP,"^");)this.parseFactor(instr),instr.push(binaryInstruction("^"))},ParserState.prototype.parsePostfixExpression=function(instr){for(this.parseFunctionCall(instr);this.accept(TOP,"!");)instr.push(unaryInstruction("!"))},ParserState.prototype.parseFunctionCall=function(instr){var unaryOps=this.tokens.unaryOps;if(this.accept(TOP,(function isPrefixOperator(token){return token.value in unaryOps}))){var op=this.current;this.parseAtom(instr),instr.push(unaryInstruction(op.value))}else for(this.parseMemberExpression(instr);this.accept(TPAREN,"(");)if(this.accept(TPAREN,")"))instr.push(new Instruction(IFUNCALL,0));else{var argCount=this.parseArgumentList(instr);instr.push(new Instruction(IFUNCALL,argCount))}},ParserState.prototype.parseArgumentList=function(instr){for(var argCount=0;!this.accept(TPAREN,")");)for(this.parseExpression(instr),++argCount;this.accept("TCOMMA");)this.parseExpression(instr),++argCount;return argCount},ParserState.prototype.parseMemberExpression=function(instr){for(this.parseAtom(instr);this.accept(TOP,".")||this.accept("TBRACKET","[");){var op=this.current;if("."===op.value){if(!this.allowMemberAccess)throw new Error('unexpected ".", member access is not permitted');this.expect("TNAME"),instr.push(new Instruction(IMEMBER,this.current.value))}else{if("["!==op.value)throw new Error("unexpected symbol: "+op.value);if(!this.tokens.isOperatorEnabled("["))throw new Error('unexpected "[]", arrays are disabled');this.parseExpression(instr),this.expect("TBRACKET","]"),instr.push(binaryInstruction("["))}}};var GAMMA_G=4.7421875,GAMMA_P=[.9999999999999971,57.15623566586292,-59.59796035547549,14.136097974741746,-.4919138160976202,3399464998481189e-20,4652362892704858e-20,-9837447530487956e-20,.0001580887032249125,-.00021026444172410488,.00021743961811521265,-.0001643181065367639,8441822398385275e-20,-26190838401581408e-21,36899182659531625e-22];function gamma(n){var t,x;if(function isInteger(value){return isFinite(value)&&value===Math.round(value)}(n)){if(n<=0)return isFinite(n)?1/0:NaN;if(n>171)return 1/0;for(var value=n-2,res=n-1;value>1;)res*=value,value--;return 0===res&&(res=1),res}if(n<.5)return Math.PI/(Math.sin(Math.PI*n)*gamma(1-n));if(n>=171.35)return 1/0;if(n>85){var twoN=n*n,threeN=twoN*n,fourN=threeN*n,fiveN=fourN*n;return Math.sqrt(2*Math.PI/n)*Math.pow(n/Math.E,n)*(1+1/(12*n)+1/(288*twoN)-139/(51840*threeN)-571/(2488320*fourN)+163879/(209018880*fiveN)+5246819/(75246796800*fiveN*n))}--n,x=GAMMA_P[0];for(var i=1;i<GAMMA_P.length;++i)x+=GAMMA_P[i]/(n+i);return t=n+GAMMA_G+.5,Math.sqrt(2*Math.PI)*Math.pow(t,n+.5)*Math.exp(-t)*x}function stringOrArrayLength(s){return Array.isArray(s)?s.length:String(s).length}function hypot(){for(var sum=0,larg=0,i=0;i<arguments.length;i++){var div,arg=Math.abs(arguments[i]);larg<arg?(sum=sum*(div=larg/arg)*div+1,larg=arg):sum+=arg>0?(div=arg/larg)*div:arg}return larg===1/0?1/0:larg*Math.sqrt(sum)}function condition(cond,yep,nope){return cond?yep:nope}function roundTo(value,exp){return void 0===exp||0==+exp?Math.round(value):(value=+value,exp=-+exp,isNaN(value)||"number"!=typeof exp||exp%1!=0?NaN:(value=value.toString().split("e"),+((value=(value=Math.round(+(value[0]+"e"+(value[1]?+value[1]-exp:-exp)))).toString().split("e"))[0]+"e"+(value[1]?+value[1]+exp:exp))))}function setVar(name,value,variables){return variables&&(variables[name]=value),value}function arrayIndex(array,index){return array[0|index]}function max(array){return 1===arguments.length&&Array.isArray(array)?Math.max.apply(Math,array):Math.max.apply(Math,arguments)}function min(array){return 1===arguments.length&&Array.isArray(array)?Math.min.apply(Math,array):Math.min.apply(Math,arguments)}function arrayMap(f,a){if("function"!=typeof f)throw new Error("First argument to map is not a function");if(!Array.isArray(a))throw new Error("Second argument to map is not an array");return a.map((function(x,i){return f(x,i)}))}function arrayFold(f,init,a){if("function"!=typeof f)throw new Error("First argument to fold is not a function");if(!Array.isArray(a))throw new Error("Second argument to fold is not an array");return a.reduce((function(acc,x,i){return f(acc,x,i)}),init)}function arrayFilter(f,a){if("function"!=typeof f)throw new Error("First argument to filter is not a function");if(!Array.isArray(a))throw new Error("Second argument to filter is not an array");return a.filter((function(x,i){return f(x,i)}))}function stringOrArrayIndexOf(target,s){if(!Array.isArray(s)&&"string"!=typeof s)throw new Error("Second argument to indexOf is not a string or array");return s.indexOf(target)}function arrayJoin(sep,a){if(!Array.isArray(a))throw new Error("Second argument to join is not an array");return a.join(sep)}function sign(x){return(x>0)-(x<0)||+x}var ONE_THIRD=1/3;function cbrt(x){return x<0?-Math.pow(-x,ONE_THIRD):Math.pow(x,ONE_THIRD)}function expm1(x){return Math.exp(x)-1}function log1p(x){return Math.log(1+x)}function log2(x){return Math.log(x)/Math.LN2}function Parser(options){this.options=options||{},this.unaryOps={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sinh:Math.sinh||sinh,cosh:Math.cosh||cosh,tanh:Math.tanh||tanh,asinh:Math.asinh||asinh,acosh:Math.acosh||acosh,atanh:Math.atanh||atanh,sqrt:Math.sqrt,cbrt:Math.cbrt||cbrt,log:Math.log,log2:Math.log2||log2,ln:Math.log,lg:Math.log10||log10,log10:Math.log10||log10,expm1:Math.expm1||expm1,log1p:Math.log1p||log1p,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,trunc:Math.trunc||trunc,"-":neg,"+":Number,exp:Math.exp,not,length:stringOrArrayLength,"!":factorial,sign:Math.sign||sign},this.binaryOps={"+":add,"-":sub,"*":mul,"/":div,"%":mod,"^":Math.pow,"||":concat,"==":equal,"!=":notEqual,">":greaterThan,"<":lessThan,">=":greaterThanEqual,"<=":lessThanEqual,and:andOperator,or:orOperator,in:inOperator,"=":setVar,"[":arrayIndex},this.ternaryOps={"?":condition},this.functions={random,fac:factorial,min,max,hypot:Math.hypot||hypot,pyt:Math.hypot||hypot,pow:Math.pow,atan2:Math.atan2,if:condition,gamma,roundTo,map:arrayMap,fold:arrayFold,filter:arrayFilter,indexOf:stringOrArrayIndexOf,join:arrayJoin},this.consts={E:Math.E,PI:Math.PI,true:!0,false:!1}}Parser.prototype.parse=function(expr){var instr=[],parserState=new ParserState(this,new TokenStream(this,expr),{allowMemberAccess:this.options.allowMemberAccess});return parserState.parseExpression(instr),parserState.expect("TEOF","EOF"),new Expression(instr,this)},Parser.prototype.evaluate=function(expr,variables){return this.parse(expr).evaluate(variables)};var sharedParser=new Parser;Parser.parse=function(expr){return sharedParser.parse(expr)},Parser.evaluate=function(expr,variables){return sharedParser.parse(expr).evaluate(variables)};var optionNameMap={"+":"add","-":"subtract","*":"multiply","/":"divide","%":"remainder","^":"power","!":"factorial","<":"comparison",">":"comparison","<=":"comparison",">=":"comparison","==":"comparison","!=":"comparison","||":"concatenate",and:"logical",or:"logical",not:"logical","?":"conditional",":":"conditional","=":"assignment","[":"array","()=":"fndef"};Parser.prototype.isOperatorEnabled=function(op){var optionName=function getOptionName(op){return optionNameMap.hasOwnProperty(op)?optionNameMap[op]:op}(op),operators=this.options.operators||{};return!(optionName in operators)||!!operators[optionName]}}}]);